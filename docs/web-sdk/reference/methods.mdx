# API 参考

JadeView Web SDK 提供了与 JadeView WebView 进行 IPC 通信的 API，主要包括以下方法：

## window.jade.invoke

**函数签名**：`<T = any>(command: string, payload?: any): Promise<T>`

**参数**：
| 参数名 | 类型 | 描述 |
|-------|------|------|
| command | string | 后端命令名称 |
| payload | any | 传递给后端的数据（可选） |

**返回值**：`Promise<T>` - 后端返回结果的 Promise

**描述**：调用后端 API 并获取返回结果，支持异步操作。

**示例代码**：

```javascript
// 调用后端 API
async function sendMessage() {
  try {
    const messageData = {
      timestamp: Date.now(),
      data: '测试消息',
    };
    const result = await window.jade?.invoke('message', messageData);
    console.log('Backend return result:', result);
  } catch (error) {
    console.error('Call failed:', error);
  }
}
```

## window.jade.on

**函数签名**：`(eventName: string, callback: (payload: any) => void) => () => void`

**参数**：
| 参数名 | 类型 | 描述 |
|-------|------|------|
| eventName | string | 事件名称 |
| callback | (payload: any) => void | 事件触发时的回调函数 |

**返回值**：`() => void` - 取消订阅的函数

**描述**：订阅后端事件，当事件触发时调用提供的回调函数。返回一个函数用于取消订阅。

**示例代码**：

```javascript
// 订阅事件
const unsubscribe = window.jade?.on('setTheme', (payload) => {
  console.log('Theme change event:', payload);
  // 处理主题变化逻辑
});

// 取消订阅
// unsubscribe();
```

## 类型定义

JadeView Web SDK 提供了以下类型定义：

### JadeView

**接口签名**：`interface JadeView`

**描述**：JadeView 主接口，代表 `window.jade` 对象。

**方法**：
- `invoke: <T = any>(command: string, payload?: any) => Promise<T>` - 调用后端 API
- `on: (eventName: string, callback: (payload: any) => void) => () => void` - 订阅后端事件

## 最佳实践

1. **检查可用性**：在使用 `window.jade` 对象之前，始终检查其是否可用
2. **使用可选链**：使用可选链 `?.` 访问 `window.jade` 的方法，避免运行时错误
3. **异步处理**：使用 `async/await` 或 Promise 处理 `invoke` 方法的异步返回值
4. **妥善管理回调**：及时取消不再需要的订阅，避免内存泄漏
5. **处理异步初始化**：考虑 JadeView IPC 系统的异步初始化特性
6. **错误处理**：添加适当的错误处理，提高应用的健壮性
7. **类型安全**：使用 TypeScript 获得完整的类型安全和 IntelliSense 支持

## 注意事项

1. **环境限制**：JadeView Web SDK 仅在 JadeView WebView 环境中可用
2. **类型安全**：使用 TypeScript 可以获得更好的类型安全支持
3. **异步通信**：IPC 通信是异步的，不能保证立即完成
4. **性能考虑**：避免频繁发送大量数据，影响应用性能
5. **安全性**：注意处理来自原生应用的数据，避免安全风险

## 常见问题

### Q: window.jade 未定义怎么办？
A: 确保您的应用运行在 JadeView WebView 环境中，并检查 JadeView IPC 系统是否已初始化。

### Q: 如何处理复杂数据结构？
A: 新的 API 支持直接传递复杂数据结构，无需使用 `JSON.stringify` 转换。

### Q: 如何避免内存泄漏？
A: 及时取消不再需要的订阅，使用 `on` 方法返回的取消订阅函数。

### Q: 如何调试 IPC 通信？
A: 使用浏览器开发者工具的控制台，打印发送和接收的消息。

### Q: 支持哪些浏览器？
A: JadeView Web SDK 支持所有现代浏览器，包括 Chrome、Firefox、Safari、Edge 等。