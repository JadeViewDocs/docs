---
title: 执行 JavaScript
sidebar_position: 2
---

# 执行 JavaScript

## 重要通知：当前限制

**当前 `execute_javascript` 功能存在较多实现问题，暂不推荐使用**。由于技术限制，直接执行 JavaScript 可能导致不可预期的行为，包括性能问题、安全风险和稳定性问题。

### 推荐替代方案

**强烈建议使用以下替代方案**：

1. **预载 JavaScript (preload_js)**：在 WebView 初始化时注入预加载脚本，实现前后端通信
2. **IPC 通信**：通过事件机制实现前后端交互

关于 JavaScript 执行的设计思路和最佳实践，请参考 [JS 运行设计](/spec/javascript-execution) 文档。

## execute_javascript

在指定窗口的 WebView 中执行 JavaScript 代码。

### 函数签名

```c
int execute_javascript(uint32_t window_id, const char* script, IpcCallback callback);
```

### 参数说明

| 参数 | 类型 | 说明 |
|------|------|------|
| `window_id` | uint32_t | 窗口 ID |
| `script` | const char* | 要执行的 JavaScript 代码 |
| `callback` | [IpcCallback](/guides/reference/data-structures#%E5%9B%9E%E8%B0%83%E5%87%BD%E6%95%B0%E7%B1%BB%E5%9E%8B%E5%AE%9A%E4%B9%89) | 可选的回调函数，用于获取JavaScript执行结果。如果不需要结果，可以传入`NULL` |

### 返回值说明

| 返回值 | 说明 |
|---------|------|
| `1` | 成功 |
| `0` | 失败 |

### 功能描述

在指定窗口的WebView中执行JavaScript代码。如果提供了回调函数，执行结果会通过回调返回。

### 回调函数数据格式

当提供了回调函数时，JavaScript执行结果会通过`javascript-result`事件返回，事件数据格式如下：

```json
{
    "callbackId": 回调ID,
    "result": 执行结果
}
```

### 使用示例

#### 示例1：无回调版本

```c
// 在ID为1的窗口中执行JavaScript代码（无返回结果）
execute_javascript(1, "alert('Hello from C API!');", NULL);
```

#### 示例2：带回调版本

```c
// 回调函数定义
int js_result_callback(uint32_t window_id, const char* event_data) {
    printf("JavaScript执行结果: %s\n", event_data);
    return 1;
}

// 在ID为1的窗口中执行JavaScript代码并获取结果
execute_javascript(1, "1 + 2", js_result_callback);
```

#### 示例3：执行复杂JavaScript并获取结果

```c
// 回调函数定义
int js_complex_callback(uint32_t window_id, const char* event_data) {
    printf("复杂JavaScript执行结果: %s\n", event_data);
    return 1;
}

// 执行复杂JavaScript代码
execute_javascript(
    1,
    "const obj = {name: 'JadeView', version: '0.1.0'}; JSON.stringify(obj)",
    js_complex_callback
);
```

### 注意事项

1. 回调函数会在JavaScript执行完成后被调用，执行结果会被序列化为JSON字符串。
2. 如果JavaScript执行过程中发生错误，错误信息会通过回调返回。
3. 回调函数是异步调用的，不会阻塞当前线程。
4. 回调函数中接收到的`event_data`是UTF-8编码的JSON字符串，需要自行解析。
