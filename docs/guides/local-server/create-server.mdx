---
title: 创建服务器
sidebar_position: 1
---

# 创建本地服务器

## create_local_server

创建本地服务器，注册自定义协议，用于访问本地文件。

### 函数签名

```c
int create_local_server(const char* root_path, const char* appname, char* url_buffer, size_t buffer_size);
```

### 参数说明

| 参数 | 类型 | 说明 |
|------|------|------|
| `root_path` | const char* | 本地文件根目录路径 |
| `appname` | const char* | 应用名称，用于构造自定义协议 URL，NULL 或空字符串表示使用默认名称 "localhost" |
| `url_buffer` | char* | 输出参数，用于存储构造的自定义协议 URL |
| `buffer_size` | size_t | url_buffer 的大小 |

### 返回值说明

| 返回值 | 说明 |
|---------|------|
| `1` | 成功 |
| `0` | 失败 |

### 功能描述

创建本地服务器，注册自定义协议，用于访问本地文件。

### 使用示例

**重要：窗口必须在 `app-ready` 事件触发后才能创建**，否则会导致创建失败。

```c
#include "jadeview.h"

// app-ready 事件回调函数
// app-ready 事件说明：
// - 触发条件：应用初始化完成
// - 参数1：整数，1表示成功，0表示失败
// - 参数2：字符串，"success"或失败原因文本
int app_ready_callback(int success, const char* reason) {
    // 检查初始化是否成功
    if (success == 1 && reason && strcmp(reason, "success") == 0) {
        // 创建本地服务器，指定根目录，获取自定义协议 URL
        char url[128];
        int result = create_local_server(
            "C:\\myapp\\dist",
            "myapp",
            url,
            sizeof(url)
        );

        if (result == 1) {
            printf("本地服务器创建成功，URL：%s\n", url);
            // 使用返回的 URL 创建 WebView 窗口
            // create_webview_window 函数参数说明：
            // - url: 初始加载的 URL
            // - parent_window_id: 父窗口 ID，0 表示无父窗口
            // - options: WebViewWindowOptions 指针，NULL 表示使用默认选项，详情：[/guides/reference/data-structures#webview-窗口选项结构体](/guides/reference/data-structures#webview-窗口选项结构体)
            // - webview_settings: WebViewSettings 指针，NULL 表示使用默认设置，详情：[/guides/reference/data-structures#webview-设置结构体](/guides/reference/data-structures#webview-设置结构体)
            uint32_t new_window_id = create_webview_window(url, 0, NULL, NULL);
            if (new_window_id == 0) {
                printf("窗口创建失败\n");
            } else {
                printf("窗口创建成功，窗口 ID：%u\n", new_window_id);
            }
        } else {
            printf("本地服务器创建失败\n");
        }
    } else {
        printf("JadeView 初始化失败：%s\n", reason ? reason : "未知错误");
    }
    
    return 0;
}

int main() {
    // 初始化 DLL
    int result = JadeView_init(1, NULL, NULL);
    if (result == 0) {
        printf("DLL 初始化失败\n");
        return 1;
    }
    
    // 注册 app-ready 事件
    jade_on("app-ready", app_ready_callback);
    
    // 运行消息循环
    run_message_loop();
    
    return 0;
}
```

## 使用自定义协议

### 功能描述

创建本地服务器后，可以使用返回的自定义协议 URL 来访问本地文件。例如，如果返回的 URL 是 `JADE://myapp`，那么可以通过以下方式访问本地文件：

- `JADE://myapp/index.html`：访问根目录下的 index.html 文件
- `JADE://myapp/assets/css/style.css`：访问 assets/css 目录下的 style.css 文件
- `JADE://myapp/api/data.json`：访问 api 目录下的 data.json 文件

### 注意事项

1. 自定义协议 URL 使用 `JADE://` 作为协议头，而不是标准的 `http://` 或 `https://`
2. appname 参数用于构造自定义协议 URL 的域名部分，如 `JADE://appname/`
3. 根目录路径必须是绝对路径
4. 本地服务器会自动处理 MIME 类型，无需手动配置
5. 自定义协议 URL 只能在 JadeView 内部使用，外部浏览器无法访问

## 本地服务器的优势

- **安全**：自定义协议 URL 不受浏览器同源策略限制，同时避免了直接文件路径的安全风险
- **性能**：直接访问本地文件，加载速度快
- **方便部署**：将所有资源打包到本地目录，无需额外的 Web 服务器
- **支持 SPA**：支持单页应用的路由处理
- **跨平台**：在不同平台上表现一致
